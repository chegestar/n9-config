#!/usr/bin/perl
use strict;
use warnings;
use IPC::Open3 qw(open3);
use Time::HiRes qw(sleep);

my $usage = "Usage: $0 NAME DELAY_MILLIS CMDSTR\n";
my $logBaseDir = "/home/user/.cache/logs";

sub main(@){
  die $usage if @_ != 3 or $_[0] !~ /^[a-zA-Z0-9_\-]+$/ or $_[1] !~ /^\d+$/;
  my ($name, $delayMillis, $cmd) = @_;
  my $now = time;
  my $logDir = "$logBaseDir/$name-daemon";
  system "mkdir", "-p", $logDir;
  my $logFile = "$logDir/$now.log";

  open LOG, ">>$logFile" or die "Could not append to $logFile\n";
  print LOG "started $name daemon\n";
  print LOG "\n\n\n";
  close LOG;

  while(1){
    sleep $delayMillis/1000.0;
    open LOG, ">>$logFile" or die "Could not append to $logFile\n";
    print LOG `date`;

    my $pid = open3("<&STDIN", ">&LOG", ">&LOG", $cmd);
    waitpid $pid, 0;

    print LOG "\n\n\n";
    close LOG;
  }
}

&main(@ARGV);
