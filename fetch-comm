#!/usr/bin/perl
use strict;
use warnings;

sub run(@);
sub runOrDie(@);

sub main(@){
  my $type = shift() || '';
  die "Usage: $0 [sms|call]\n" if $type !~ /^(sms|call)$/;

  my $dir = "$ENV{HOME}/Code/n9";
  my $dest = "$dir/backup";
  my $qtcommExec = "${type}backuprestore";
  my $parseTool = "comm-tool.pl $type";

  my $host = `n9`;
  chomp $host;

  my $srcDir = "/home/user/MyDocs/backup-$type";
  my $destDir = "$dest/backup-$type";

  my $remoteRepoDir = "$srcDir-repo";

  run "n9", "-s", "killall -9 $qtcommExec";
  run "n9", "-s", "/opt/dropcache-mdn/bin/dropcache.sh --3";
  if($type eq "sms"){
    runOrDie "n9", "-b", "backup-comm-n9e $type";
  }elsif($type eq "call"){
    runOrDie "n9", "-b", "backup-comm-scbr $type --retry 20";
  }
  runOrDie "mkdir", "-p", $destDir;
  runOrDie "rsync", "-avP", "root\@$host:$srcDir/", $destDir;
  runOrDie "perl $dir/$parseTool split";
  runOrDie "perl $dir/$parseTool commit";
  runOrDie "perl $dir/$parseTool join-all";

  run "scp", "$destDir/all.$type", "root\@$host:$srcDir/";
  run "n9", "-s", "chown user.users -R $srcDir/all.$type";
  run "rsync", "-a", "$destDir/repo/", "root\@$host:$remoteRepoDir/";
  run "n9", "-s", "chown user.users -R $remoteRepoDir";
}

sub run(@){
  print "@_\n";
  system @_;
}
sub runOrDie(@){
  run @_;
  die "failed" if $? != 0;
}

&main(@ARGV);
